<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
    xmlns:tal="http://xml.zope.org/namespaces/tal"
    xmlns:metal="http://xml.zope.org/namespaces/metal"
    xmlns:i18n="http://xml.zope.org/namespaces/i18n"
    lang="en"
    metal:use-macro="context/main_template/macros/master"
    i18n:domain="gwopa">
<body>

<metal:content-core fill-slot="main"
    tal:define="portal_state context/@@plone_portal_state;
                portal_url portal_state/portal_url;">

  <metal:javascript fill-slot="javascript_head_slot">
    <script>
      require = undefined;
      define = undefined;
    </script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="//code.jquery.com/jquery-3.4.0.min.js"></script>
    <script src="//unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/flatpickr"></script>
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  </metal:javascript>

  <metal:block define-macro="content-core" tal:define="currentYear view/getYear">

    <h1 class="documentFirstHeading">Planning - Project Year <tal:omit-tag tal:content="currentYear">2019</tal:omit-tag></h1>
    <div class="documentDescription description projectDates">
      Start date: <tal:omit-tag tal:content="view/getFaseStart">2019-02-02</tal:omit-tag> - End date: <tal:omit-tag tal:content="view/getFaseEnd">2019-03-03</tal:omit-tag>
    </div>
    <div class="block-nav">
      <ul class="pagination pagination-lg" tal:define="items view/getItems">
        <tal:block tal:repeat="item items">
          <li tal:attributes="class item/classe">
            <a href="#" tal:attributes="href item/url"><tal:omit-tag tal:content="item/title"></tal:omit-tag>
            </a>
          </li>
        </tal:block>
      </ul>
    </div>

    <span tal:content="view/getPhases" id="totalPhases" style="display: none"></span>
    <div style="float:right; padding-top: 10px;" class="documentDescription">
      <span id="collapseAll" i18n:translate="">Collapse all <i class="fa fa-chevron-up" aria-hidden="true"></i></span>
      <span id="expandAll" i18n:translate="">Show all <i class="fa fa-chevron-down" aria-hidden="true"></i></span>
    </div>

    <div id="tabsplanning" class="container">
      <ul class="nav nav-pills">
        <li class="active">
          <a href="#project" data-toggle="tab">Project</a>
        </li>
        <li><a href="#outcomes" data-toggle="tab">Outcomes</a>
        </li>
      </ul>
      <div class="tab-content clearfix">
        <div class="tab-pane active" id="project">
          <tal:block-activities tal:define="areas view/getAreas" tal:condition="areas">
            <tal:objects repeat="item areas">
              <div class="tabla_contenido_items" tal:define="files python:view.indicatorsInside(item);">
                  <div class="tabla_cabecera">
                    <div class="tabla_hilera">
                      <div class="tabla_info">
                        <div class="information object" id="header">
                          <div class="contentt" id="total">
                            <div class="btn-group" role="group" aria-label="Add element">
                              <div data-toggle="dropdown"><i class="fas fa-plus-circle"></i></div>
                              <ul class="dropdown-menu" role="menu" aria-labelledby="types">
                                <li>
                                  <a class="pat-plone-modal" tabindex="-1" href="" tal:attributes="href string:${item/url}/++add++Activity">
                                    <i class="fas fa-plus-circle"></i><tal:omit-tag i18n:translate="">Add Activity</tal:omit-tag>
                                  </a>
                                </li>
                                <li>
                                  <a data-toggle="modal" data-target="#modalOutput">
                                    <i class="fas fa-plus-circle"></i><tal:omit-tag i18n:translate="">Add Output</tal:omit-tag>
                                  </a>
                                </li>
                              </ul>
                            </div>
                            <div class="titleRowPlanning">
                              <a tal:attributes="href item/url" tal:content="item/title"> Item Title </a>
                            </div>
                          </div>
                          <div class="contentt" id="bl">Starting Date</div>
                          <div class="contentt" id="value">Completion Date</div>
                          <div class="contentt" id="target">Target Value</div>
                          <div class="contentt" id="resp">Responsible</div>
                          <div class="contentt" id="actions">Action</div>
                          <a type="button" class="expand" data-original-title="Expand">
                            <i style="color: #557c95" class="fas fa-chevron-down" aria-hidden="true"></i>
                          </a>
                          <a type="button" class="notexpand" data-original-title="Collapse">
                            <i style="color: #557c95" class="fas fa-chevron-up" aria-hidden="true"></i>
                          </a>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="tabla_cuerpo" tal:repeat="item files">
                    <div class="tabla_hilera">
                      <div class="block_content">
                        <div class="col-md-12 text-item-planning">
                          <div class="information object">
                            <div class="contentt" id="total" tal:condition="python:item['portal_type'] == 'Activity'">
                              <a class="pat-plone-modal" tabindex="-1" href="" tal:attributes="href string:${item/url}/++add++Output"><i class="fa fa-plus-circle"></i></a>
                              <div tal:attributes="class string:${item/portal_type}-planning" tal:content="item/portal_type">Activity/output label</div>
                              <h4 class="titulocatplan" id="output" tal:content="item/title"> Activity/Output Title </h4>
                            </div>
                            <div class="contentt" id="total" tal:condition="python:item['portal_type'] == 'Output'">
                              <div tal:attributes="class string:${item/portal_type}-planning" tal:content="item/portal_type">Activity/output label</div>
                              <h4 class="titulocatplan" id="output" tal:content="item/title"> Activity/Output Title </h4>
                            </div>
                            <div class="contentt" id="bl" tal:content="item/start">2019-03-29</div>
                            <div class="contentt" id="value" tal:content="item/end">2019-03-30</div>
                            <div class="contentt" id="target">
                              <tal:omit-tag tal:content="item/value"> Value </tal:omit-tag>
                              <tal:omit-tag tal:content="item/unit"> Unit </tal:omit-tag>
                            </div>
                            <div class="contentt" id="resp" tal:define="members item/responsible">
                              <ul tal:condition="members"><li tal:repeat="member members" tal:content="member"> Member Name </li></ul>
                              <tal:block tal:condition="not:members" i18n:translate=""> Not assigned </tal:block>
                            </div>
                            <div class="contentt" id="actions">
                              <a class="pat-plone-modal"
                                tal:attributes="
                                  href string:${item/url}/edit;
                                  title string:Edit ${item/title};
                                  alt string:Edit ${item/title}"><i class="far fa-edit"></i></a>
                              <a href="#confirm-delete" data-toggle="modal"  class="btn-delete"
                                tal:attributes="
                                  data-url item/url;
                                  data-type item/portal_type;
                                  data-id item/title;" title="Delete" alt="Delete">
                                <i class="far fa-trash-alt"></i></a>
                            </div>
                          </div>
                      <tal:block tal:condition="python:item['portal_type'] == 'Activity'" tal:define="outputs python:view.indicatorsInside(item);">
                        <div tal:repeat="output outputs" class="block_sub_indicators">
                          <div class="information object">
                            <div class="contentt" id="total">
                            <div tal:attributes="class string:${output/portal_type}-planning indent-item" tal:content="output/portal_type">Type Output</div>
                            <h4 class="titulocatplan" tal:content="output/title"> Item Title </h4>
                          </div>
                            <div class="contentt" id="bl" tal:content="output/start">2019-03-29</div>
                            <div class="contentt" id="value" tal:content="output/end">2019-03-30</div>
                            <div class="contentt" id="target">
                              <tal:omit-tag tal:content="output/value"> Value </tal:omit-tag>
                              <tal:omit-tag tal:content="output/unit"> Unit </tal:omit-tag>
                            </div>
                            <div class="contentt" id="resp" tal:define="members output/responsible">
                              <ul tal:condition="members"><li tal:repeat="member members" tal:content="member"> Member Name </li></ul>
                              <ul tal:condition="not:members"><li i18n:translate=""> Not assigned </li></ul>
                            </div>
                            <div class="contentt" id="actions">
                              <a class="pat-plone-modal"
                                tal:attributes="
                                  href string:${output/url}/edit;
                                  title string:Edit ${output/title};
                                  alt string:Edit ${output/title}"><i class="far fa-edit"></i></a>
                              <a href="#confirm-delete" data-toggle="modal"  class="btn-delete"
                                tal:attributes="
                                  data-url item/url;
                                  data-type item/portal_type;
                                  data-id item/title;" title="Delete" alt="Delete">
                                <i class="far fa-trash-alt"></i></a>
                            </div>
                          </div>
                        </div>
                      </tal:block>
                    </div>
                    </div>
                    </div>
                  </div>
              </div>
            </tal:objects>
          </tal:block-activities>
        </div>

        <div class="tab-pane" id="outcomes">
          <div class="tabla_contenido_items" tal:define="outcomes view/listOutcomesKPI">
            <div class="tabla_cabecera">
              <div class="tabla_hilera">
                <div class="tabla_info">
                  <div class="information object" id="header">
                    <div class="contentt" id="total">
                      <div class="btn-group" role="group" aria-label="Add KPI">
                        <div data-toggle="dropdown"><i class="fas fa-plus-circle"></i></div>
                        <ul class="dropdown-menu" role="menu" aria-labelledby="kpis">
                          <li><a class="pat-plone-modal" tabindex="-1" href="" tal:attributes="href string:${context/absolute_url}/++add++OutcomeKPI"><span><i class="fas fa-plus-circle"></i> New Overall KPI </span></a></li>
                          <li><a class="pat-plone-modal" tabindex="-1" href="" tal:attributes="href string:${context/absolute_url}/++add++OutcomeZONE"><span><i class="fas fa-plus-circle"></i> New KPI Zone </span></a></li>
                        </ul>
                      </div>
                      <div class="titleRowPlanning">
                        <tal:omit-tag i18n:translate=""> Utility Performance </tal:omit-tag>
                      </div>
                    </div>
                    <div class="contentt" id="bl">Baseline Date</div>
                    <div class="contentt" id="value">Baseline Value</div>
                    <div class="contentt" id="target">Target Value</div>
                    <div class="contentt" id="mu">Frequency</div>
                    <div class="contentt" id="resp">Responsible</div>
                    <div class="contentt" id="actions">Action</div>
                    <div class="contentt" id="down">
                      <i class="fas fa-chevron-down"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="tabla_cuerpo">
              <div class="tabla_hilera">
                <div class="block_content">
                  <tal:objects repeat="outcome outcomes">
                    <div class="col-md-12 text-item-planning">
                      <div class="information object">
                        <div class="contentt" id="total">
                          <div tal:attributes="class string:${outcome/portal_type}-planning" tal:content="outcome/portal_type"> Outcome - KPI Type</div>
                          <h4 class="titulocatplan" tal:content="outcome/title">KPI</h4>
                        </div>
                        <div class="contentt" id="bl" tal:content="outcome/base_date">2019-03-30</div>
                        <div class="contentt" id="value" tal:content="outcome/base_value">2019-06-22</div>
                        <div class="contentt" id="target">
                          <tal:omit-tag tal:content="outcome/target_value"> Value </tal:omit-tag>
                          <tal:omit-tag tal:content="outcome/measuring_unit"> Unit </tal:omit-tag>
                        </div>
                        <div class="contentt" id="freq" tal:content="outcome/measuring_frequency"> Frequency </div>
                          <div class="contentt" id="resp" tal:define="members outcome/responsible">
                            <ul tal:condition="members"><li tal:repeat="member members" tal:content="member"> Member Name </li></ul>
                            <ul tal:condition="not:members"><li i18n:translate=""> Not assigned </li></ul>
                          </div>
                        <div class="contentt" id="actions">
                          <a class="pat-plone-modal" tal:attributes="href string:${outcome/url}/edit" title="Edit" alt="Edit">
                            <i class="far fa-edit"></i>
                          </a>
                          <a href="#confirm-delete" data-toggle="modal" class="btn-delete"
                            tal:attributes="
                                  data-url outcome/url;
                                  data-type outcome/portal_type;
                                  data-id outcome/title;" title="Delete" alt="Delete">
                            <i class="far fa-trash-alt"></i>
                          </a>
                        </div>
                      </div>
                    </div>
                  </tal:objects>
                </div>
              </div>
            </div>
          </div>
          <tal:block-capacity tal:define="outcomes view/listOutcomesCC" tal:condition="outcomes">
            <div class="tabla_cabecera">
              <div class="tabla_hilera">
                <div class="tabla_info">
                  <div class="information object" id="header">
                    <div class="contentt" id="total">
                      <div class="titleRowPlanning">
                        <tal:omit-tag i18n:translate=""> Utility Capacity </tal:omit-tag>
                      </div>
                    </div>

                  </div>
                </div>
              </div>
            </div>
            <div class="tabla_cuerpo">
              <div class="tabla_hilera">
                <div class="block_content">
                  <div class="col-md-12 text-item-planning" tal:repeat="outcome outcomes">
                    <div class="information object">
                      <div class="contentt" id="total">
                        <div class="btn-group" role="group" aria-label="Add element">
                          <div data-toggle="dropdown">
                            <i class="fas fa-plus-circle"></i>
                          </div>
                          <ul class="dropdown-menu" role="menu" aria-labelledby="types">
                            <li>
                              <a class="pat-plone-modal" tabindex="-1" tal:attributes="href string:${outcome/url}/++add++OutcomeCC">
                                  <i class="fas fa-plus-circle"></i>&nbsp;<tal:omit-tag i18n:translate="">Improve generic Capacity Change</tal:omit-tag></a>
                            </li>
                            <li>
                              <a class="pat-plone-modal" tabindex="-1" tal:attributes="href string:${outcome/url}/++add++OutcomeCCS">
                                  <i class="fas fa-plus-circle"></i>&nbsp;<tal:omit-tag i18n:translate="">Improve specific Capacity Change</tal:omit-tag></a>
                            </li>
                          </ul>
                        </div>
                        <div class="CC-planning">Improve capacity in</div>
                        <h4 class="titulocatplan" id="output" tal:content="outcome/area"> Working Area 1 </h4>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </tal:block-capacity>
        </div>
      </div>
    </div>

    <div class="modal fade" id="modalOutput" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
              <h4 class="modal-title" id="exampleModalLabel"> Add Output </h4>
            </div>
            <div class="modal-body" id="NewKPI">
              <div class="col-md-12">
                <div class="form-group">
                  <label for="recipient-name" class="control-label">Title</label>
                  <span class="requiredfield" title="Required"> <i class="fas fa-circle"></i> </span>
                  <input type="text" class="form-control" name="Name" required="True" id="out-title">
                </div>
                <div class="form-group">
                  <label for="message-text" class="control-label">Description</label>
                  <textarea class="form-control" id="out-description"></textarea>
                </div>
                <div class="form-group">
                  <label for="message-text" class="control-label">Baseline description</label>
                  <textarea class="form-control" id="out-baseline"></textarea>
                </div>
                <div class="form-group">
                  <label class="control-label">Completion Date</label>
                  <span class="requiredfield" title="Required"> <i class="fas fa-circle"></i> </span>
                   <input type='text' class="form-control" id='out-datetimepicker'/>
                </div>
                <div class="form-group">
                  <label for="message-text" class="control-label">Measuring unit:</label>
                  <select id="out-unit" name="measuring" class="form-control">
                    <option value="2">Liters</option>
                    <option value="1">%</option>
                    <option value="3">m3</option>
                    <option value="4">People</option>
                    <option value="5">Others</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="message-text" class="control-label">Measuring frequency:</label>
                  <select id="out-frequency" name="measuring" class="form-control">
                      <option value="1">Quarterly</option>
                      <option value="2">Biannually</option>
                      <option value="3">Annually</option>
                  </select>
                </div>
                <div id='TextBoxesGroup'>
                  <div id="TextBoxDiv1">
                    <div class="col-md-6">
                      <label for="message-text" class="control-label"> Target value </label>
                      <input class="form-control" id="target-value-1" />
                    </div>
                    <div class="col-md-6">
                      <label for="message-text" class="control-label"> Target date </label>
                      <input class="form-control" id="target-date-1"  readonly/>
                    </div>
                  </div>
                </div>
                <button type="button" id='addTargetValueButton'>
                  <i class="fa fa-plus-circle" aria-hidden="true"></i>
                  Add target
                </button>
                <div class="form-group">
                  <label for="message-text" class="control-label">Means of verification</label>
                  <textarea class="form-control" id="out-means"></textarea>
                </div>
                <div class="form-group">
                  <label for="message-text" class="control-label">Risks / Assumptions</label>
                  <textarea class="form-control" id="out-risks"></textarea>
                </div>
                <div class="form-group">
                  <label for="message-text" class="control-label">Responsible people</label>
                  <input type="hidden" class="pat-select2" id="out-responsible"
                              data-pat-select2="placeholder:Search users;
                                                vocabularyUrl:select2-users.json;"/>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" id="createOutputFromModal" class="btn btn-default" data-dismiss="modal">Create</button>
            </div>
        </div>
      </div>
    </div>

<script type="text/javascript">
  $('#createOutputFromModal').click(function(e){
      e.preventDefault();
      alert($('#out-title').val());
      /*
      $.post('http://path/to/post',
         $('#myForm').serialize(),
         function(data, status, xhr){
           // do something here with response;
         });
      */
});

</script>
    <script type="text/javascript">
        $(document).ready(function(){

          let counter = 1;
          let numPhases = $('#totalPhases').text();
          fetch('./api-getphases')
          .then(response => {
              return response.json()
          })
          .then(data => {
              let end_date = data[0].gwopa_year_phases[0].end;
              $('#target-date-1').val(end_date);
          })

          $("#addTargetValueButton").click(function () {
              let idnum = counter + 1;
              if(counter>=numPhases){
                  swal(
                    'Not allowed!',
                    'Sorry, but this output only accepts ' + numPhases + ' target values.',
                    'warning');
              }
              else {
                let newTextBoxDiv = $(document.createElement('div')).attr("id", 'TextBoxDiv' + idnum);
                newTextBoxDiv.after().html(
                '<div class="col-md-6">' +
                '<input class="form-control" id="target-value-' + idnum + '" placeholder="Indicate the target value..."/></div>' +
                '<div class="col-md-6">' +
                '<input class="form-control" id="target-date-' + idnum + '" readonly/></div>');
                newTextBoxDiv.appendTo("#TextBoxesGroup");
              }
              fetch('./api-getphases')
              .then(response => {
                return response.json()
              })
              .then(data => {
                  let end_date = data[0].gwopa_year_phases[idnum-1].end;
                  $('#target-date-' + (idnum) + '').val(end_date);
              })
              counter++;
          });

          $('#datetimepicker').flatpickr({
              altInput: true,
              altFormat: "F j, Y",
              dateFormat: "Y-m-d",
              allowInput: true,
          });

          $('.btn-delete').on('click', function(e) {
              e.preventDefault();
              item = $(this).attr('data-url')
              item_type = $(this).attr('data-type')
              item_title = $(this).attr('data-id')
              var params = {};
              params.item = item;
              swal({
                title: "Confirm Delete?",
                text: 'You are about to delete ' + item_type + ': ' + item_title,
                icon: "warning",
                buttons: true,
                dangerMode: true,
              })
              .then((willDelete) => {
                if (willDelete) {
                  $.ajax({
                    url: '@@removeElement',
                    method: 'POST',
                    data: params,
                    success: function(resp)
                          {
                            if(resp) {
                              location.reload();
                              swal("Deleted", "The item has been deleted", "success", {
                                buttons: false,
                                timer: 2000,
                              })
                            }
                          }
                })
                } else {
                  swal("Cancelled", "The item has not been deleted", "error", {
                    buttons: false,
                    timer: 1200,
                  })
                }
              });
            });

        });
    </script>
    <script type="text/javascript">
        $(".notexpand").hide();
        $("#expandAll").hide()
        $(".tabla_cuerpo").slideDown()

        $("#expandAll").click(function(){
          $(".tabla_cuerpo").slideDown()

          $(".expand").parent().parent().parent().slideDown();
          $(".expand").hide();
          $(".notexpand").show();
          $("#expandAll").hide();
          $("#collapseAll").show();
        })

        $("#collapseAll").click(function(){
          $(".tabla_cuerpo").slideUp()
          $(".notexpand").slideUp();
          $(".notexpand").hide();
          $(".expand").show();
          $("#expandAll").show();
          $("#collapseAll").hide();
        })

      $(".expand").click(function () {
        $(".expand").hide();
        $(".notexpand").show();

        $header = $(this);
        $header.parent().parent().parent().parent().parent().find('.tabla_cuerpo').slideToggle(500);
      });

      $(".notexpand").click(function () {
        $(".notexpand").hide();
        $(".expand").show();
        $header = $(this);
        $header.parent().parent().parent().parent().parent().find('.tabla_cuerpo').slideToggle(500);
      });

    </script>



  </metal:block>

</metal:content-core>

</body>
</html>
