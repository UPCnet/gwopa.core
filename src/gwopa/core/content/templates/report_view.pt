<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  xmlns:i18n="http://xml.zope.org/namespaces/i18n"
  lang="en"
  metal:use-macro="context/main_template/macros/master"
  i18n:domain="gwopa">

<body>
<metal:content-core fill-slot="main"
  tal:define="portal_state context/@@plone_portal_state;
  portal_url portal_state/portal_url;
  gwopa_utils context/@@gwopa.utils;">
  <tal:omit-tag-ini tal:define="canViewPlanningMonitoring gwopa_utils/canViewPlanningMonitoring;">
    <metal:block tal:condition="not: canViewPlanningMonitoring">
      <h1 class="documentFirstHeading" i18n:translate="">Insufficient permissions</h1>
    </metal:block>
    <metal:block tal:condition="canViewPlanningMonitoring" define-macro="content-core"
      tal:define="canEditPlanningMonitoring gwopa_utils/canEditPlanningMonitoring;
                  currentYear view/getYear;
                  report view/reportData;
                  viewProjectOverview view/viewProjectOverview;
                  viewSummary view/viewSummary;
                  viewActivities view/viewActivities;
                  viewOutcomes view/viewOutcomes;
                  viewBudget view/viewBudget">

      <h1 class="documentFirstHeading">
        <tal:omit-tag i18n:translate=""> Report </tal:omit-tag>
        -
        <span tal:content="view/projectTitle"></span>
      </h1>
      <div class="documentDescription description projectDates">
        <span class="dateNumbers">
          <tal:omit-tag i18n:translate=""> Project year </tal:omit-tag>&nbsp;<tal:omit-tag tal:content="currentYear"> 2019 </tal:omit-tag>
        </span>
        <tal:omit-tag i18n:translate=""> goes from </tal:omit-tag>&nbsp;<span tal:content="view/getFaseStart" class="dateNumbers"> 2019-02-02 </span>&nbsp;<tal:omit-tag i18n:translate=""> to </tal:omit-tag>&nbsp;<span tal:content="view/getFaseEnd" class="dateNumbers"> 2019-03-03 </span>&nbsp;<span tal:content="view/getPhases" id="totalPhases" style="display: none"></span>


      </div>

      <div id="reportActions">
        <a tal:attributes="href string:${view/projectURL}/reporting">
        <button id="returnReporting" class="context focus" i18n:translate="">Return</button>
        </a>
        <a tal:attributes="href string:${context/absolute_url}/edit">
        <button id="editReporting" class="context focus right" i18n:translate="">Edit</button>
        </a>
        <!--<a tal:attributes="href string:${view/projectURL}/saveReport">
        <button id="saveReport" class="context focus right" i18n:translate="">Save</button>
        </a>-->
        <a id="dlink" style="display:none;"></a>
        <span id="filename" style="display:none;" tal:content="report/project_overview/project_name">Project Name</span>
        <span id="generation_report_date" style="display:none;" tal:content="report/generation_report_date">Generation report date</span>
        <button type="button" class="context focus right" onclick="javascript:window.print()">
          <i class="fa fa-print" aria-hidden="true"></i>
          <span>Print</span>
        </button>

<!--           <button id="downloadReport" onclick="tablesToExcel(['tabla1', 'tabla2', 'tabla3', 'tabla4', 'tabla5'], ['first', 'second', 'third','fourth','five']);" class="context focus right" i18n:translate="">Download</button> -->
        <!--
          <button id="btn-export" onclick="tablesToExcel(['tabla1', 'tabla2', 'tabla3', 'tabla4', 'tabla5'], ['first', 'second', 'third','fourth','five'], 'test.xlsx');">Export to Excel
              doc</button> -->
      </div>

      <div id="reportPreviewProject" class="row tabla_contenido_items">
        <div tal:condition="report" tal:define="styles view/getStyles">
          <!-- <h2>Full 2: <em>Project Overview </em></h2> -->

          <ul class="nav nav-tabs">
            <li class="nav-item active">
             <a class="nav-link active" data-toggle="tab" href="#tabla1">PROJECT OVERVIEW</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-toggle="tab" href="#tabla2">SUMMARY</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-toggle="tab" href="#tabla3">ACTIVITIES AND OUTPUTS PROGRESS</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-toggle="tab" href="#tabla4">OUTCOMES</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-toggle="tab" href="#tabla5">BUDGET</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-toggle="tab" href="#tabla6">PRINT</a>
            </li>
          </ul>
          <div class="tab-content" id="myTabContent">

            <div class="tab-pane container active" id="tabla1">
              <block metal:use-macro="context/macro-report-project/project"></block>
            </div>

            <div class="tab-pane container fade" id="tabla2">
              <block metal:use-macro="context/macro-report-summary/summary"></block>
            </div>

            <div class="tab-pane container fade" id="tabla3">
              <block metal:use-macro="context/macro-report-activities/activities"></block>
            </div>

            <div class="tab-pane container fade" id="tabla4">
              <block metal:use-macro="context/macro-report-outcomes/outcomes"></block>
            </div>

            <div class="tab-pane container fade" id="tabla5">
              <block metal:use-macro="context/macro-report-budget/budget"></block>
            </div>

            <div class="tab-pane container fade" id="tabla6">
              <block tal:condition="viewProjectOverview" metal:use-macro="context/macro-report-project/project"></block>
              <block tal:condition="viewSummary" metal:use-macro="context/macro-report-summary/summary"></block>
              <block tal:condition="viewActivities" metal:use-macro="context/macro-report-activities/activities"></block>
              <block tal:condition="viewOutcomes" metal:use-macro="context/macro-report-outcomes/outcomes"></block>
              <block tal:condition="viewBudget" metal:use-macro="context/macro-report-budget/budget"></block>
            </div>

          </div>
        </div>
      </div>
      <!--     <div class="content-footer">
        <button id="btn-export" onclick="tablesToExcel(['tabla1'], ['first'], ['Exportacio']);">Export to Excel
            doc</button>
        </div>
        -->
      <link rel="stylesheet" href="++theme++gwopa.theme/assets/javascripts/jquery-editable.css" rel="stylesheet"/>
      <script type="text/javascript" src="++theme++gwopa.theme/assets/javascripts/jquery.poshytip.js"></script>
      <script type="text/javascript" src="++theme++gwopa.theme/assets/javascripts/jquery-editable-poshytip.js"></script>
      <script type="text/javascript" src="++plone++static/components/bootstrap/js/modal.js"></script>
      <script type="text/javascript" src="++plone++static/components/bootstrap/js/tab.js"></script>
      <script type="text/javascript" src="++theme++gwopa.theme/assets/javascripts/report-kpis.js"></script>
      <!-- <script type="text/javascript" src="++theme++gwopa.theme/assets/javascripts/reporting.js"></script> -->
      <script>
        var tablesToExcel = (function () {
            var uri = 'data:application/vnd.ms-excel;base64,'
            //template amb les url per convertirse a fitxer excel, de microsoft.

            , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>{worksheet}</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml>'
            //caracteristiques del template
            , templateend = '</x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--></head>'
            , body = '<body>'
            , tablevar = '<table>{table'
            , tablevarend = '}</table>'
            , bodyend = '</body></html>'
            , worksheet = '<x:ExcelWorksheet><x:Name>'
            , worksheetend = '</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet>'
            , worksheetvar = '{worksheet'
            , worksheetvarend = '}'
            , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
            , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }
            , wstemplate = ''
            , tabletemplate = '';

              // retorna la taula, el nom de la taula i el nom de l'arxiu
              return function (table, name) {
              // es declara la variable taules per poguer mostrar casdascuna delles.
                var tables = table;


                for (var i = 0; i < tables.length; ++i) {
                    wstemplate += worksheet + worksheetvar + i + worksheetvarend + worksheetend;
                    tabletemplate += tablevar + i + tablevarend;
                }

                //suma de tots els templates
                var allTemplate = template + wstemplate + templateend;
                var allWorksheet = body + tabletemplate + bodyend;
                var allOfIt = allTemplate + allWorksheet;

                var ctx = {};
                for (var j = 0; j < tables.length; ++j) {
                    ctx['worksheet' + j] = name[j];
                }

                //itera les taules dins del for perque pugui anar sumant les corresponents id de cada taula
                for (var k = 0; k < tables.length; ++k) {
                    var exceltable;
                    if (!tables[k].nodeType) exceltable = document.getElementById(tables[k]);
                    ctx['table' + k] = exceltable.innerHTML;
                }

                document.getElementById("dlink").href = uri + base64(format(allOfIt, ctx));
                document.getElementById("dlink").download = $("#filename").text() + "_" + $("#generation_report_date").text() + ".xls";
                document.getElementById("dlink").click();

                //format 64 per poguer mostrarho
                //window.location.href = uri + base64(format(allOfIt, ctx));
            }
        })();

      </script>
    </metal:block>
  </tal:omit-tag-ini>
</metal:content-core>
</body>
</html>
